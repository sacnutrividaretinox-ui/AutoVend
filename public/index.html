<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoVend - Publicador em Massa (CSV ‚Üí Mercado Livre)</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; background:#fafafa; padding:20px;}
    .card {background:white; border-radius:12px; padding:16px; margin:10px 0; box-shadow:0 2px 8px rgba(0,0,0,0.05);}
    button {background:#111827;color:white;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;}
    button[disabled]{opacity:0.6;cursor:not-allowed;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:14px;}
    .muted{color:#6b7280;font-size:14px;}
  </style>
</head>
<body>
  <h1>üöÄ AutoVend - Publicador em Massa</h1>

  <div class="card">
    <h2>1Ô∏è‚É£ Conectar Conta Mercado Livre</h2>
    <input id="userId" placeholder="Nome do usu√°rio" />
    <button id="btnConnect">üîó Conectar Mercado Livre</button>
  </div>

  <div class="card">
    <h2>2Ô∏è‚É£ Upload CSV</h2>
    <form id="formUpload"><input type="file" name="file" accept=".csv" required /> <button>Enviar</button></form>
    <div id="uploadResult" class="muted"></div>
  </div>

  <div class="card">
    <h2>3Ô∏è‚É£ Publicar Produtos</h2>
    <label>Limite: <input id="limit" type="number" value="5" min="1" max="200" /></label>
    <button id="btnPublish">üöÄ Publicar</button>
    <div id="publishResult" class="muted"></div>
  </div>

  <div class="card">
    <h2>4Ô∏è‚É£ Logs</h2>
    <button id="btnLogs">üìú Ver Logs</button>
    <div id="logs"></div>
  </div>

<script>
const $ = (s)=>document.querySelector(s);

$("#btnConnect").onclick=()=>{
  const user=$("#userId").value.trim();
  if(!user)return alert("Digite o nome do usu√°rio!");
  window.open(`/ml/auth/${user}`,"_blank","width=600,height=700");
};

$("#formUpload").onsubmit=async(e)=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  $("#uploadResult").textContent="Enviando...";
  const r=await fetch("/api/upload",{method:"POST",body:fd});
  const j=await r.json();
  $("#uploadResult").innerHTML=`${j.count} produtos carregados.`;
};

$("#btnPublish").onclick=async()=>{
  const user=$("#userId").value.trim();
  if(!user)return alert("Digite o nome do usu√°rio!");
  const limit=Number($("#limit").value);
  $("#publishResult").textContent="Publicando...";
  const r=await fetch("/api/publish/ml",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:user,limit})});
  const j=await r.json();
  $("#publishResult").innerHTML=`Processados: ${j.processed} | Sucesso: ${j.success} | Falhas: ${j.failed}`+renderTable(j.results);
};

$("#btnLogs").onclick=async()=>{
  const r=await fetch("/api/logs");
  const j=await r.json();
  $("#logs").innerHTML=renderTable(j.logs.slice(-50).reverse());
};

function renderTable(rows){
  if(!rows||!rows.length)return"<p class='muted'>(sem dados)</p>";
  const cols=Object.keys(rows[0]);
  return "<table><tr>"+cols.map(c=>`<th>${c}</th>`).join("")+"</tr>"+rows.map(r=>"<tr>"+cols.map(c=>`<td>${r[c]??""}</td>`).join("")+"</tr>").join("")+"</table>";
}
</script>
</body>
</html>
